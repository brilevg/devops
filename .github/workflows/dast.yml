name: DAST
on:
  workflow_dispatch:

jobs:
  zap:
    permissions:
      issues: write
      contents: read
    runs-on: ubuntu-latest
    environment: secret
    env:
      FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
      DB_TYPE: "fake"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.9"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Start application
        run: |
          # Запускаем приложение в фоне на порту 8000
          nohup python -m flask run --host=0.0.0.0 --port=8000 > app.log 2>&1 &
          # Ждем, пока приложение запустится
          sleep 10
          # Проверяем, что приложение работает
          curl -f http://localhost:8000 || true
      - name: Run OWASP ZAP DAST scan
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: 'http://localhost:8000'
          upload_artifact: true         
          artifact_name: "dast-baseline" 
          cmd_options: "-J report.json -w report.md -r report.html"
        

      - name: Stop application
        run: |
          pkill -f "flask run" || true
      - name: List files (for debugging)
        run: |
          echo "Current directory structure:"
          find . -name "*.html" -o -name "*.json" -o -name "*.xml" | head -20
          echo "ZAP reports likely location:"
          ls -la zap_* 2>/dev/null || echo "No zap_* files found"
          ls -la *.html 2>/dev/null || echo "No HTML files found"
  
      - name: Upload DAST report
        uses: actions/upload-artifact@v4
        with:
          name: dast-report
          path: |
            zap_report.html
            zap_*.html
            *.html
          if-no-files-found: warn
          retention-days: 30


  nikto:
    runs-on: ubuntu-latest
    environment: secret
    env:
      FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
      DB_TYPE: "fake"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.9"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Start application
        run: |
          # Запускаем приложение в фоне на порту 8001
          nohup python -m flask run --host=0.0.0.0 --port=8001 > app.log 2>&1 &
          # Ждем, пока приложение запустится
          sleep 10
          # Проверяем, что приложение работает
          curl -f http://localhost:8001 || true

      - name: Nikto scan
        run: |
          sudo apt install nikto -y
          nikto -h http://localhost:8001

  nuclei:
    runs-on: ubuntu-latest
    environment: secret
    env:
      FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
      DB_TYPE: "fake"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.9"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Start application
        run: |
          # Запускаем приложение в фоне на порту 8002
          nohup python -m flask run --host=0.0.0.0 --port=8002 > app.log 2>&1 &
          # Ждем, пока приложение запустится
          sleep 10
          # Проверяем, что приложение работает
          curl -f http://localhost:8002 || true

      - name: Install nuclei
        run: |
           curl -sL https://raw.githubusercontent.com/projectdiscovery/nuclei/master/install.sh | sh
           sudo mv nuclei /usr/local/bin/


      - name: Run nuclei
        run: nuclei -u http://localhost:8002
